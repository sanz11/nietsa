<?phpclass Inventario extends Controller {    public function __construct() {        parent::Controller();        $this->load->library('pagination');        ///stv        $this->load->model('almacen/guiain_model');        $this->load->model('almacen/guiaindetalle_model');        //////        $this->load->model('almacen/inventario_model');        $this->load->model('almacen/kardex_model');        $this->load->model('almacen/almacen_model');        $this->load->model('almacen/almacenproducto_model');        $this->somevar ['compania'] = $this->session->userdata('compania');        $this->load->model('maestros/configuracion_model');    }    public function listar($j = 0) {        $this->load->library('layout', 'layout');        $count_datos = $this->inventario_model->count_inventario();        $data['registros'] = $count_datos[0]->conteo;        $data['lista'] = array();        $data['titulo_busqueda'] = 'Listado de Inventarios Realizados';        $conf['base_url'] = site_url('almacen/inventario/listar/');        $conf['per_page'] = 15;        $conf['num_links'] = 3;        $conf['next_link'] = "&gt;";        $conf['prev_link'] = "&lt;";        $conf['first_link'] = "&lt;&lt;";        $conf['total_rows'] = $data['registros'];        $conf['last_link'] = "&gt;&gt;";        $conf['uri_segment'] = 4;        $offset = (int) $this->uri->segment(4);        $this->pagination->initialize($conf);        $data['t_indice'] = $j;        $datos = $this->inventario_model->buscar_inventario(NULL, $conf['per_page'], $offset);        $data['paginacion'] = $this->pagination->create_links();        $data['lista'] = $datos;        $this->layout->view('almacen/inventario_index', $data);    }    public function listar_refresh($j = 0) {        $count_datos = $this->inventario_model->count_inventario();        $data['registros'] = $count_datos[0]->conteo;        $data['lista'] = array();        $data['titulo_busqueda'] = 'Listado de Inventarios Realizados';        $conf['base_url'] = site_url('almacen/inventario/listar/');        $conf['per_page'] = 15;        $conf['num_links'] = 3;        $conf['next_link'] = "&gt;";        $conf['prev_link'] = "&lt;";        $conf['first_link'] = "&lt;&lt;";        $conf['total_rows'] = $data['registros'];        $conf['last_link'] = "&gt;&gt;";        $conf['uri_segment'] = 4;        $offset = (int) $this->uri->segment(4);        $this->pagination->initialize($conf);        $data['t_indice'] = $j;        $datos = $this->inventario_model->buscar_inventario(NULL, $conf['per_page'], $offset);        $data['paginacion'] = $this->pagination->create_links();        $data['lista'] = $datos;        $this->load->view('almacen/inventario_index_refresh', $data);    }    public function nuevo() {        $data['titulo'] = '';        $data['action'] = base_url() . 'index.php/almacen/inventario/insertar';        $data['fecha_registro'] = date('d/m/Y');        $data['cod_inventario'] = '';        $compania = $this->session->userdata('compania');        // $establecimiento = $this->session->userdata('idcompania');        $data['almacenes'] = $this->almacen_model->buscar_x_compania($compania);        $data['almacen'] = '';        $documento = $this->configuracion_model->obtener_numero_documento($compania, 4);        $data['serie'] = str_pad($documento[0]->CONFIC_Serie, 3, "0", STR_PAD_LEFT);        $data['numero'] = str_pad($documento[0]->CONFIC_Numero, 6, "0", STR_PAD_LEFT);        $this->load->view('almacen/inventario_nuevo', $data);    }    public function modificar($cod_inventario) {        $data['titulo'] = 'MODIFICAR INVENTARIO';        $data['action'] = base_url() . 'index.php/almacen/inventario/editar';        $data['fecha_registro'] = date('d/m/Y');        $data['cod_inventario'] = $cod_inventario;        $compania = $this->session->userdata('compania');        $data['almacenes'] = $this->almacen_model->buscar_x_compania($compania);        $filter = new stdClass();        $filter->cod_inventario = $cod_inventario;        $datos = $this->inventario_model->buscar_inventario($filter);        $data['almacen'] = $datos[0]->ALMAP_Codigo;        $data['titulo'] = $datos[0]->INVE_Titulo;        $data['serie'] = str_pad($datos[0]->INVE_Serie, 3, "0", STR_PAD_LEFT);        $data['numero'] = str_pad($datos[0]->INVE_Numero, 6, "0", STR_PAD_LEFT);        $this->load->view('almacen/inventario_nuevo', $data);    }    public function insertar() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $resul = $this->inventario_model->insertar($datos);            if ($resul)                die('ok');            else                die('ERROR: No se puedo completar la operación.');        }    }    public function editar() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $USUACodi= $this->session->userdata('user');                 $resul = $this->inventario_model->editar($datos,$USUACodi);            if ($resul)                die('ok');            else                die('ERROR: No se puedo completar la operación.');        }    }    public function agregar_detalle($cod_inventario) {        $data['titulo'] = 'AGREGAR DETALLE AL INVENTARIO';        $data['action'] = base_url() . 'index.php/almacen/inventario/insertar_detalle';        $data['fecha_registro'] = date('d/m/Y');        $data['cod_inventario'] = $cod_inventario;        $filter = new stdClass();        $filter->cod_inventario = $cod_inventario;        $datos = $this->inventario_model->buscar_inventario($filter);        $data['titulo'] = $datos[0]->INVE_Titulo;        $data['serie'] = str_pad($datos[0]->INVE_Serie, 3, "0", STR_PAD_LEFT);        $data['numero'] = str_pad($datos[0]->INVE_Numero, 6, "0", STR_PAD_LEFT);        $this->load->view('almacen/inventario_nuevo_detalle', $data);    }    public function insertar_detalle() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $result = $this->inventario_model->insertar_detalle($datos);            if ($result) {                $this->cargar_detalle($datos['cod_inventario']);            }        }    }    public function editar_detalle() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $result = $this->inventario_model->editar_detalle($datos);            if ($result)                $this->cargar_detalle($datos['cod_inventario']);        }    }    public function eliminar_detalle() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $result = $this->inventario_model->eliminar_detalle($datos);            if ($result)                $this->cargar_detalle($datos['cod_inventario']);        }    }    public function generar_movimiento($cod_detalle, $cod_inventario) {    	//    if ($_SERVER['REQUEST_METHOD'] === 'POST') {    	//  $datos = $_POST;    	    	//  $cod_detalle = $datos['cod_detalle'];    	    	$filter_ = new stdClass();    	$filter_->codigo_detalle = $cod_detalle;    	    	$data = $this->inventario_model->buscar_inventario_detalles($filter_);    	    	    	$filter = new stdClass();    	$filter->KARD_Fecha = date('Y-m-d');    	    	$filter->KARDC_Cantidad = $data[0]->INVD_Cantidad;    	$filter->PROD_Codigo = $data[0]->PROD_Codigo;    	    	    	///////    	$filter->KARDC_Costo = $data[0]->INVD_Pcosto;    	/////////    	    	    	$filter->KARDC_TipoIngreso = 3;    	$filter->LOTP_Codigo = NULL;    	$filter->TIPOMOVP_Codigo = NULL;    	    	///stv    	$prod='';    	$cod_inv='';    	$cod_inv=$data[0]->INVE_Codigo;    	$prod=$data[0]->PROD_Codigo;    	////    	    	$filter->KARDC_CodigoDoc = $data[0]->INVE_Codigo;    	    	$this->kardex_model->insertar(4, $filter);    	    	    	////////////aumentado  stv    	    	$filter7 = new stdClass();    	$filter7->cod_inventario = $cod_inv;    	$data_inv = $this->inventario_model->buscar_inventario($filter7);    	$almacen='';    	if(count($data_inv)>0){    		$almacen=$data_inv[0]->ALMAP_Codigo;    	}    	    	//////cabecera            	$filter3 = new stdClass();    	$filter3->TIPOMOVP_Codigo = 2;    	$filter3->ALMAP_Codigo = $almacen;    	$filter3->PROVP_Codigo = 543;    	$filter3->DOCUP_Codigo = 8;    	$filter3->GUIAINC_Fecha = date('Y-m-d');    	$filter3->GUIAINC_Observacion = '';    	$filter3->USUA_Codigo = 1;    	$filter3->GUIAINC_Automatico = 1;    	$guia_id = $this->guiain_model->insertar($filter3);    	    	    	////////detalle    	$filter4 = new stdClass();    	$filter4->GUIAINP_Codigo = $guia_id;    	$filter4->PRODCTOP_Codigo = $prod;    	$filter4->UNDMED_Codigo = 1;    	$filter4->GUIIAINDETC_GenInd = NULL;    	    	/////    	$filter4->GUIAINDETC_Cantidad = 0;  //$data[0]->INVD_Cantidad    	//////    	    	////////    	$filter4->GUIAINDETC_Costo = $data[0]->INVD_Pcosto;;    	////////    	// No estoy muy seguro de si debe agarrar este precio, porque puede ser $costo, $venta    	    	$filter4->GUIAINDETC_Descripcion = 'G';    	$this->guiaindetalle_model->insertar($filter4);    	    	       	    	$filter__ = new stdClass();    	$filter__->cod_inventario = $data[0]->INVE_Codigo;    	    	$datos_inventaio = $this->inventario_model->buscar_inventario($filter__);    	    	$this->almacenproducto_model->colocar_stock($datos_inventaio[0]->ALMAP_Codigo, $data[0]->PROD_Codigo, $data[0]->INVD_Cantidad);    	    	$result = $this->inventario_model->editar_detalle_activacion($cod_detalle);    	    	if ($result)    		$this->cargar_detalle($cod_inventario);    		else    			die('ERROR');    			//   }    }    public function cargar_detalle($cod_inventario, $j = 0) {                $data['lista'] = array();        $filter = new stdClass();        $filter->codigo_inventario = $cod_inventario;        $c_datos = count($this->inventario_model->buscar_inventario_detalles($filter));               $conf['base_url'] = site_url('almacen/inventario/cargar_detalle/' + $cod_inventario);        $conf['per_page'] = 10;        $conf['num_links'] = 3;        $conf['next_link'] = "&gt;";        $conf['prev_link'] = "&lt;";        $conf['first_link'] = "&lt;&lt;";        $conf['total_rows'] = $c_datos;        $conf['last_link'] = "&gt;&gt;";        $conf['uri_segment'] = 5;        $offset = (int) $this->uri->segment(5);        $this->pagination->initialize($conf);        $data['t_indice'] = $j;        $datos = $this->inventario_model->buscar_inventario_detalles($filter, $conf['per_page'], $j);        $data['paginacion'] = $this->pagination->create_links();        $data['lista'] = $datos;        $this->load->view('almacen/inventario_detalle_refresh', $data);    }    public function encuentrax_producto() {        $compania = $this->somevar['compania'];        $keyword = $this->input->post('term');        $filter=new stdClass();        $filter->nombre=$keyword;        $filter->flagBS='B';        $result = array();        if($keyword!=null && count(trim($keyword))>0){       		$datosProducto= $this->producto_model->buscar_productos_general($filter,null,null);        //         $query = mysql_query("SELECT `cji_producto`.*//          FROM (`cji_productocompania`)//          LEFT JOIN `cji_producto` ON `cji_producto`.`PROD_Codigo` = `cji_productocompania`.`PROD_Codigo`//          WHERE PROD_FlagBienServicio = 'B'//          AND   `cji_productocompania`.`COMPP_Codigo`='".$compania."'//          AND   `cji_producto`.`PROD_FlagEstado`=1//          AND `cji_producto`.`PROD_Nombre` LIKE '%" . $keyword . "%' ORDER BY `cji_producto`.`PROD_Nombre` LIMIT 30");                foreach ($datosProducto as $indice => $valor) {            $cod_prod = $valor->PROD_Codigo;            $almacen_id=null;          	$datosAlmacenProducto=$this->almacenproducto_model->obtener($almacen_id, $cod_prod);//         $consulta = mysql_fetch_assoc(mysql_query("SELECT ALMPROD_Stock FROM  `cji_almacenproducto` WHERE PROD_Codigo=" . $cod_prod));			$stock=0;			if($datosAlmacenProducto!=null && count($datosAlmacenProducto)>0){				$stock=$datosAlmacenProducto[0]->ALMPROD_Stock;			}          	            $result[] = array("value" => $valor->PROD_Nombre, "codigo" => $valor->PROD_Codigo, "codinterno" => $valor->PROD_CodigoUsuario, "stock" =>$stock);        }                        }                                echo json_encode($result);    }public function ingresarInventario2(){    $inicio=$this->input->post('inicio');    $final=$this->input->post('final');    $cod_inventario=$this->input->post('inventario');    $dataList= $this->inventario_model->buscarProductoXInventario($inicio,$final);    if(count($dataList)>0){      foreach ($dataList as $key => $value) {      echo $value->PROD_Codigo."<br>";    $dataLista=  $this->inventario_model->buscarDetalleProducto($value->PROD_Codigo,$cod_inventario);     if(count($dataLista)>0){    }else{        $filter = new stdClass();        $filter->INVE_Codigo =$cod_inventario;        $filter->PROD_Codigo =$value->PROD_Codigo;        $filter->INVD_Cantidad = 0;        $filter->INVD_Pcosto = 1;        $filter->INVD_FechaRegistro = date('Y-m-d');        $this->inventario_model->insertar_detalle2($filter);        }            }  }else{    echo "se a finalizo";  }}public function ingresar_kardex2(){   $inicio=$this->input->post('inicio');    $final=$this->input->post('final');    $cod_inventario=$this->input->post('inventario');    $dataList = $this->inventario_model->buscar_inventario_($inicio,$final);    if(count($dataList)>0){             foreach ($dataList as $key => $value) {                $dataLista=  $this->inventario_model->buscarDetalleProducto($value->PROD_Codigo,$value->INVE_Codigo);           if(count($dataLista)>0){            echo $value->PROD_Codigo."<br>";             $filter = new stdClass();                  $filter->KARD_Fecha = date('Y-m-d');                $filter->KARDC_Cantidad = $value->INVD_Cantidad;        $filter->PROD_Codigo = $value->PROD_Codigo;                        ///////        $filter->KARDC_Costo = $value->INVD_Pcosto;        /////////                        $filter->KARDC_TipoIngreso = 3;        $filter->LOTP_Codigo = NULL;        $filter->TIPOMOVP_Codigo = NULL;                ///stv        $prod='';        $cod_inv='';        $cod_inv=$value->INVE_Codigo;        $prod=$value->PROD_Codigo;        $filter->KARDC_CodigoDoc = $value->INVE_Codigo;                $this->kardex_model->insertar(4, $filter);                $filter7 = new stdClass();        $filter7->cod_inventario = $cod_inv;        $data_inv = $this->inventario_model->buscar_inventario($filter7);        $almacen='';        if(count($data_inv)>0){            $almacen=$data_inv[0]->ALMAP_Codigo;        }                //////cabecera        $filter3 = new stdClass();        $filter3->TIPOMOVP_Codigo = 2;        $filter3->ALMAP_Codigo = $almacen;        $filter3->PROVP_Codigo = 543;        $filter3->DOCUP_Codigo = 8;        $filter3->GUIAINC_Fecha = date('Y-m-d');        $filter3->GUIAINC_Observacion = '';        $filter3->USUA_Codigo = 1;        $filter3->GUIAINC_Automatico = 1;        $guia_id = $this->guiain_model->insertar($filter3);                        ////////detalle        $filter4 = new stdClass();        $filter4->GUIAINP_Codigo = $guia_id;        $filter4->PRODCTOP_Codigo = $prod;        $filter4->UNDMED_Codigo = 1;        $filter4->GUIIAINDETC_GenInd = NULL;        $filter4->GUIAINDETC_Cantidad = 0;         $filter4->GUIAINDETC_Costo = $value->INVD_Pcosto;;        $filter4->GUIAINDETC_Descripcion = 'G';        $this->guiaindetalle_model->insertar($filter4);                                $filter__ = new stdClass();        $filter__->cod_inventario = $value->INVE_Codigo;                $datos_inventaio = $this->inventario_model->buscar_inventario($filter__);                $this->almacenproducto_model->colocar_stock($datos_inventaio[0]->ALMAP_Codigo, $value->PROD_Codigo, $value->INVD_Cantidad);                $result = $this->inventario_model->editar_detalle_activacion($cod_detalle);                }           else{           }       }               }else{        echo "se a finalizado";    }            }}