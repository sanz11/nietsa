<?phpclass Inventario extends Controller {    public function __construct() {        parent::Controller();        $this->load->library('pagination');        $this->load->model('almacen/inventario_model');        $this->load->model('almacen/kardex_model');        $this->load->model('almacen/almacen_model');        $this->load->model('almacen/almacenproducto_model');        $this->somevar ['compania'] = $this->session->userdata('compania');        $this->load->model('maestros/configuracion_model');    }    public function listar($j = 0) {        $this->load->library('layout', 'layout');        $count_datos = $this->inventario_model->count_inventario();        $data['registros'] = $count_datos[0]->conteo;        $data['lista'] = array();        $data['titulo_busqueda'] = 'Listado de Inventarios Realizados';        $conf['base_url'] = site_url('almacen/inventario/listar/');        $conf['per_page'] = 15;        $conf['num_links'] = 3;        $conf['next_link'] = "&gt;";        $conf['prev_link'] = "&lt;";        $conf['first_link'] = "&lt;&lt;";        $conf['total_rows'] = $data['registros'];        $conf['last_link'] = "&gt;&gt;";        $conf['uri_segment'] = 4;        $offset = (int) $this->uri->segment(4);        $this->pagination->initialize($conf);        $data['t_indice'] = $j;        $datos = $this->inventario_model->buscar_inventario(NULL, $conf['per_page'], $offset);        $data['paginacion'] = $this->pagination->create_links();        $data['lista'] = $datos;        $this->layout->view('almacen/inventario_index', $data);    }    public function listar_refresh($j = 0) {        $count_datos = $this->inventario_model->count_inventario();        $data['registros'] = $count_datos[0]->conteo;        $data['lista'] = array();        $data['titulo_busqueda'] = 'Listado de Inventarios Realizados';        $conf['base_url'] = site_url('almacen/inventario/listar/');        $conf['per_page'] = 15;        $conf['num_links'] = 3;        $conf['next_link'] = "&gt;";        $conf['prev_link'] = "&lt;";        $conf['first_link'] = "&lt;&lt;";        $conf['total_rows'] = $data['registros'];        $conf['last_link'] = "&gt;&gt;";        $conf['uri_segment'] = 4;        $offset = (int) $this->uri->segment(4);        $this->pagination->initialize($conf);        $data['t_indice'] = $j;        $datos = $this->inventario_model->buscar_inventario(NULL, $conf['per_page'], $offset);        $data['paginacion'] = $this->pagination->create_links();        $data['lista'] = $datos;        $this->load->view('almacen/inventario_index_refresh', $data);    }    public function nuevo() {        $data['titulo'] = '';        $data['action'] = base_url() . 'index.php/almacen/inventario/insertar';        $data['fecha_registro'] = date('d/m/Y');        $data['cod_inventario'] = '';        $compania = $this->session->userdata('compania');        // $establecimiento = $this->session->userdata('idcompania');        $data['almacenes'] = $this->almacen_model->buscar_x_compania($compania);        $data['almacen'] = '';        $documento = $this->configuracion_model->obtener_numero_documento($compania, 4);        $data['serie'] = str_pad($documento[0]->CONFIC_Serie, 3, "0", STR_PAD_LEFT);        $data['numero'] = str_pad($documento[0]->CONFIC_Numero, 6, "0", STR_PAD_LEFT);        $this->load->view('almacen/inventario_nuevo', $data);    }    public function modificar($cod_inventario) {        $data['titulo'] = 'MODIFICAR INVENTARIO';        $data['action'] = base_url() . 'index.php/almacen/inventario/editar';        $data['fecha_registro'] = date('d/m/Y');        $data['cod_inventario'] = $cod_inventario;        $compania = $this->session->userdata('compania');        $data['almacenes'] = $this->almacen_model->buscar_x_compania($compania);        $filter = new stdClass();        $filter->cod_inventario = $cod_inventario;        $datos = $this->inventario_model->buscar_inventario($filter);        $data['almacen'] = $datos[0]->ALMAP_Codigo;        $data['titulo'] = $datos[0]->INVE_Titulo;        $data['serie'] = str_pad($datos[0]->INVE_Serie, 3, "0", STR_PAD_LEFT);        $data['numero'] = str_pad($datos[0]->INVE_Numero, 6, "0", STR_PAD_LEFT);        $this->load->view('almacen/inventario_nuevo', $data);    }    public function insertar() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $resul = $this->inventario_model->insertar($datos);            if ($resul)                die('ok');            else                die('ERROR: No se puedo completar la operación.');        }    }    public function editar() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $resul = $this->inventario_model->editar($datos);            if ($resul)                die('ok');            else                die('ERROR: No se puedo completar la operación.');        }    }    public function agregar_detalle($cod_inventario) {        $data['titulo'] = 'AGREGAR DETALLE AL INVENTARIO';        $data['action'] = base_url() . 'index.php/almacen/inventario/insertar_detalle';        $data['fecha_registro'] = date('d/m/Y');        $data['cod_inventario'] = $cod_inventario;        $filter = new stdClass();        $filter->cod_inventario = $cod_inventario;        $datos = $this->inventario_model->buscar_inventario($filter);        $data['titulo'] = $datos[0]->INVE_Titulo;        $data['serie'] = str_pad($datos[0]->INVE_Serie, 3, "0", STR_PAD_LEFT);        $data['numero'] = str_pad($datos[0]->INVE_Numero, 6, "0", STR_PAD_LEFT);        $this->load->view('almacen/inventario_nuevo_detalle', $data);    }    public function insertar_detalle() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $result = $this->inventario_model->insertar_detalle($datos);            if ($result) {                $this->cargar_detalle($datos['cod_inventario']);            }        }    }    public function editar_detalle() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $result = $this->inventario_model->editar_detalle($datos);            if ($result)                $this->cargar_detalle($datos['cod_inventario']);        }    }    public function eliminar_detalle() {        if ($_SERVER['REQUEST_METHOD'] === 'POST') {            $datos = $_POST;            $result = $this->inventario_model->eliminar_detalle($datos);            if ($result)                $this->cargar_detalle($datos['cod_inventario']);        }    }    public function generar_movimiento($cod_detalle, $cod_inventario) {    //    if ($_SERVER['REQUEST_METHOD'] === 'POST') {          //  $datos = $_POST;          //  $cod_detalle = $datos['cod_detalle'];            $filter_ = new stdClass();            $filter_->codigo_detalle = $cod_detalle;            $data = $this->inventario_model->buscar_inventario_detalles($filter_);            $filter = new stdClass();            $filter->KARD_Fecha = date('Y-m-d');            $filter->KARDC_Cantidad = $data[0]->INVD_Cantidad;            $filter->PROD_Codigo = $data[0]->PROD_Codigo;            $filter->KARDC_Costo = 0;            $filter->KARDC_TipoIngreso = 3;            $filter->LOTP_Codigo = NULL;            $filter->TIPOMOVP_Codigo = NULL;            $filter->KARDC_CodigoDoc = $data[0]->INVE_Codigo;            $this->kardex_model->insertar(4, $filter);            $filter__ = new stdClass();            $filter__->cod_inventario = $data[0]->INVE_Codigo;            $datos_inventaio = $this->inventario_model->buscar_inventario($filter__);            $this->almacenproducto_model->colocar_stock($datos_inventaio[0]->ALMAP_Codigo, $data[0]->PROD_Codigo, $data[0]->INVD_Cantidad);            $result = $this->inventario_model->editar_detalle_activacion($cod_detalle);            if ($result)                $this->cargar_detalle($cod_inventario);            else                die('ERROR');     //   }    }    public function cargar_detalle($cod_inventario, $j = 0) {                $data['lista'] = array();        $filter = new stdClass();        $filter->codigo_inventario = $cod_inventario;        $c_datos = count($this->inventario_model->buscar_inventario_detalles($filter));               $conf['base_url'] = site_url('almacen/inventario/cargar_detalle/' + $cod_inventario);        $conf['per_page'] = 10;        $conf['num_links'] = 3;        $conf['next_link'] = "&gt;";        $conf['prev_link'] = "&lt;";        $conf['first_link'] = "&lt;&lt;";        $conf['total_rows'] = $c_datos;        $conf['last_link'] = "&gt;&gt;";        $conf['uri_segment'] = 5;        $offset = (int) $this->uri->segment(5);        $this->pagination->initialize($conf);        $data['t_indice'] = $j;        $datos = $this->inventario_model->buscar_inventario_detalles($filter, $conf['per_page'], $j);        $data['paginacion'] = $this->pagination->create_links();        $data['lista'] = $datos;        $this->load->view('almacen/inventario_detalle_refresh', $data);    }    public function encuentrax_producto() {        $compania = $this->somevar['compania'];        $keyword = $this->input->post('term');        $query = mysql_query("SELECT `cji_producto`.*         FROM (`cji_productocompania`)         LEFT JOIN `cji_producto` ON `cji_producto`.`PROD_Codigo` = `cji_productocompania`.`PROD_Codigo`         WHERE PROD_FlagBienServicio = 'B'         AND   `cji_productocompania`.`COMPP_Codigo`='".$compania."'         AND   `cji_producto`.`PROD_FlagEstado`=1         AND `cji_producto`.`PROD_Nombre` LIKE '" . $keyword . "%' ORDER BY `cji_producto`.`PROD_Nombre` LIMIT 10");        $result = array();        while ($data = mysql_fetch_assoc($query)) {            $cod_prod = $data['PROD_Codigo'];            $consulta = mysql_fetch_assoc(mysql_query("SELECT ALMPROD_Stock FROM  `cji_almacenproducto` WHERE PROD_Codigo=" . $cod_prod));            $result[] = array("value" => $data['PROD_Nombre'] , "codigo" => $data['PROD_Codigo'], "codinterno" => $data['PROD_CodigoUsuario'], "stock" => $consulta['ALMPROD_Stock']);        }        echo json_encode($result);    }}